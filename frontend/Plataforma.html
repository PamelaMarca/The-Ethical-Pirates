<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piratas del Cine</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="Home">
    <header class="cabezal">
        <section>
            <div class="presentacion">
                <img src="./imagenes/cine.png" alt="imagen" width="200px">
                <h1 id="titulo">Piratas del Cine</h1>                
            </div>

            <div class ="ingresar" id="ingresar">
                <a href="inicio_registro.html" class="boton">Iniciar Sesion</a>
            </div>
            
            <nav id="navegador_interno">
                <div class="icono_menu" onclick="desplegar()">☰</div>
                <div class="cuadro_interno" id="cuadro_interno">
                    <ul>
                        <li><a id="perfil_usuario">Perfil</a></li>
                        <li>
                            <button class="biblio" onclick="desplega_biblio()">Mi Biblioteca  <strong id="signo">&lt;</strong></button>
                            <ul id="menu">
                                <li><a href="favoritos.html?tipo=Series">Mis Series</a></li>
                                <li><a href="favoritos.html?tipo=Peliculas">MIs Peliculas</a></li>
                            </ul>
                        </li>
                        <li><button id="cerrar_sesion" onclick="sesion_cerrada()">Cerrar Sesion</button></li>
                    </ul>
                </div>
            </nav> 
        </section>    
        <section>
            <nav class="navegador">
                <div class="paginas">
                <a id="index"href="index.html">Home</a>
                <a href="Series.html">Series</a>
                <a href="Peliculas.html">Peliculas</a>
                </div>

                <div id="buscador">
                    <input type="text" id="search" placeholder="Buscar una película">
                    <span id="buscar">&#128269</span>
                </div>
            </nav>

        </section>
  
    </header>
    <main >
        <div class="cuadro resultados" id="cuadro">
        </div>
    </main>
    <footer>
        <p>&copy; 2024 The Ethical Pirates</p>
    </footer>
    <script src="../backend/server.js"></script>
    <script src="./js/interacciones.js"></script>
    <script src="./js/series_peliculas.js"></script>
    <script src="./js/sesion_verificar.js"></script>

    <script>
        window.onload= function(){
            verificar_sesion();
			cargar_plataformas();
        }
		function items_plataforma(dato, plataforma){
            console.log(plataforma);
            const cuadro = document.getElementById('cuadro');
            cuadro.innerHTML='';
            cuadro.innerHTML =`<div id="nombre_plataforma" style="display:flex; margin:10px;"><h3 style="margin:10px;">${plataforma}</h3></div>`;
			const boton_modificar = document.createElement('button');
			boton_modificar.innerText = 'Modificar Nombre';
			boton_modificar.onclick = () => modificar_nombre_plataforma(plataforma);
			const nombrePlataformaDiv = document.getElementById('nombre_plataforma');
			nombrePlataformaDiv.appendChild(boton_modificar);

			const lista = document.createElement('ul');
            lista.classList.add('fichas');
            dato.forEach(json=>{
                if(json.PLATAFORMA === plataforma){
                    items(json,lista);
                }
            });
            if(lista.childElementCount > 0){
                cuadro.appendChild(lista);
            }else{
                const aviso = document.createElement('div');
                aviso.classList.add('css_mensaje');
                aviso.innerHTML = 'No se encontraron items para esta plataforma';
                cuadro.appendChild(aviso);
            }
        }

		function cargar_plataformas() {
			const parametro = new URLSearchParams(window.location.search);
			const nombre = parametro.get('plataforma');			
			fetch(`http://localhost:3000/api/v1/Plataformas/${nombre}`)
			.then(respuesta => respuesta.json())
			.then(json => {
				items_plataforma(json, nombre);
			})
			.catch(error => {
				console.error('Error al cargar los items de la plataforma:', error);
				const cuadro = document.getElementById('cuadro');
				const aviso = document.createElement('div');
				aviso.classList.add('css_mensaje');
				aviso.innerHTML = 'Error al cargar los items de la plataforma';
				cuadro.appendChild(aviso);
			});
		}
		
		function guardar_nombre(plataforma){
			const nombre= document.getElementById('nuevo_nombre').value;
			if (!nombre) {
                alert('Esta vacio el campo para modificar');
                return;
            }
			fetch(`http://localhost:3000/api/v1/Plataforma/${encodeURIComponent(plataforma)}`, {
				method:'PUT',
				headers:{
                    'Content-Type': 'application/json'
				},
				body: JSON.stringify({ 
					nombre_nuevo: nombre
				})
			})
			.then(res=> res.json())
			.then(json =>{
				if(!json.mensaje)
					window.location.href= `Plataforma.html?plataforma=${nombre}`;
			})
		}
		function modificar_nombre_plataforma(plataforma){
			const nombre_p = document.getElementById('nombre_plataforma');
			nombre_p.innerHTML = '';
			const formulario = document.createElement('form');
			const titulo = document.createElement('input');
			titulo.id='nuevo_nombre';
			titulo.style.padding='5px'
			titulo.placeholder=plataforma;
			const boton_cambiar=document.createElement('button');
			boton_cambiar.innerText='Aceptar modificacion';
			boton_cambiar.id= 'cambiar';
			boton_cambiar.style.padding='5px'
			boton_cambiar.onclick=(event)=> {
				event.preventDefault();
				guardar_nombre(plataforma)
			};
			formulario.appendChild(titulo);
			formulario.appendChild(boton_cambiar);
			nombre_p.appendChild(formulario)

		}


    </script>
</body>
</html>