<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piratas del Cine</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body id="Home"class="Home">
    <header class="cabezal">
        <section>
            <div class="presentacion">
                <img src="./imagenes/cine.png" alt="imagen" width="200px">
                <h1 id="titulo">Piratas del Cine</h1>                
            </div>

            <div class ="ingresar" id="ingresar">
                <a href="inicio_registro.html" class="boton">Iniciar Sesion</a>
            </div>
            
            <nav id="navegador_interno">
                <div class="icono_menu" onclick="desplegar()">â˜°</div>
                <div class="cuadro_interno" id="cuadro_interno">
                    <ul>
                        <li><a id="perfil_usuario">Perfil</a></li>
                        <li>
                            <button class="biblio" onclick="desplega_biblio()">Mi Biblioteca  <strong id="signo">&lt;</strong></button>
                            <ul id="menu">
                                <li><a href="favoritos.html?tipo=Series">Mis Series</a></li>
                                <li><a href="favoritos.html?tipo=Peliculas">MIs Peliculas</a></li>
                            </ul>
                        </li>
<<<<<<< HEAD:frontend/mis_favoritos.html
                        <li><a href="carga.html">Subir Pelis o Series</a></li>
                        <li><a href="">Comentarios</a></li>
=======
>>>>>>> develop_v3:frontend/favoritos.html
                        <li><button id="cerrar_sesion" onclick="sesion_cerrada()">Cerrar Sesion</button></li>
                    </ul>
                </div>

            </nav> 
        </section>    
        <section>
            <nav class="navegador">
                <div class="paginas">
                <a id="index" href="index.html">Home</a>
                <a href="Series.html">Series</a>
                <a href="Peliculas.html">Peliculas</a>
                </div>

                <div id="buscador">
                    <input type="text" id="search" placeholder="Buscar ...">
                    <span id="buscar">&#128269</span>
                </div>
            </nav>

        </section>
  
    </header>
	<main>
        <div class="cuadro resultados" id="cuadro">

        </div>
	</main>
    <footer class="footer">
            <p>&copy; 2024 The Ethical Pirates</p>
    </footer>
    <script src="../backend/server.js"></script>
    <script src="./js/interacciones.js"></script>
    <script src="./js/series_peliculas.js"></script>
    <script src="./js/sesion_verificar.js"></script>
    <script src="./js/perfil.js"></script>

    <script>
        window.onload = function(){
			mostrar_fav()
            verificar_sesion();
        }
		function eliminar_favorito(id_contenido){
			const parametro = new URLSearchParams(window.location.search);
			const tipo = parametro.get('tipo');
			const token = localStorage.getItem('token');
			const us = localStorage.getItem('id_user');
			if (!token){
				alert("Inicie sesion para eliminar de favorito")
				sesion_cerrada();
				window.location.href="inicio_registro.html";
			}
			let contenido;
			if(tipo === 'Peliculas') contenido= 'pelicula';
			else if(tipo === 'Series') contenido= 'serie';

			console.log(`ID Usuario: ${us}, Tipo: ${contenido}, ID Contenido: ${id_contenido}`);
			
			fetch(`http://localhost:3000/api/v1/Favorito/${us}/${contenido}/${id_contenido}`,{
				method: "DELETE",
				headers: {
					'Authorization': 'Bearer ' + token,
					'Content-Type': 'application/json'
					}
			})
			
			.then(res => res.json())
			.then( json=>{
				if(!mensaje){
					alert("Eliminado de favoritos con exito");
					// mostrar_fav();
				}
			})
		}

		function mostrar_fav(){
			const parametro = new URLSearchParams(window.location.search);
			const tipo = parametro.get('tipo');
			const us = localStorage.getItem('id_user');
			const token = localStorage.getItem('token');
			if(!token){
				alert("Inicie para ver lista de vaforitos");
				return;
			}
			fetch(`http://localhost:3000/api/v1/Favorito/${us}/${tipo}`, {
				method:"GET",
				headers:{
				'Authorization':'Bearer ' + token,
				'Content-Type': 'application/json'
				}
			})
			.then(res => res.json())
			.then(fav =>{
				const cuadro = document.getElementById('cuadro');
				cuadro.innerHTML='';

				if(Array.isArray(fav) && fav.length > 0){
					const tabla = document.createElement('table');
					tabla.id='tabla_favoritos';
					const encabezado = document.createElement('thead');
					encabezado.innerHTML='<tr><th id="Nombres_item">Nombre</th></tr>';
					tabla.appendChild(encabezado);

					const cuerpo = document.createElement('tbody');
					fav.forEach(element => {

						const fila = document.createElement('tr');
						const celda1 = document.createElement('td');
						const titulo = document.createElement('a');
						titulo.innerText= element.contenido;
						titulo.href="Items.html?nombre=" + encodeURIComponent(element.contenido);
						celda1.appendChild(titulo);

						const celda2 = document.createElement('td');
						const eliminar = document.createElement('button');
						eliminar.classList.add('eliminar_fav');
						eliminar.id='eliminar_fav';
						eliminar.innerText="Eliminar de favoritos";
						eliminar.onclick= ()=> eliminar_favorito(element.id_contenido);
						celda2.appendChild(eliminar);

						fila.appendChild(celda1);
						fila.appendChild(celda2);
						cuerpo.appendChild(fila);
					});
					tabla.appendChild(cuerpo);
					cuadro.appendChild(tabla);
				}else{
					const mensaje = document.createElement('h2');
					mensaje.innerText="No tienes favoritos Aun";
					cuadro.appendChild(mensaje);
				}
			})
		}
      </script>
</body>
</html>